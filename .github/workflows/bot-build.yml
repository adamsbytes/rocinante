name: bot-build

on:
  pull_request:
    paths:
      - 'bot/**'
      - '.github/workflows/bot-build.yml'
  push:
    branches:
      - main
    paths:
      - 'bot/**'
      - '.github/workflows/bot-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      released: ${{ steps.release.outputs.released }}
    env:
      DOCKER_BUILDKIT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Determine next version
        id: version
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail
          latest="$(curl -sfL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" \
            | jq -r '.tag_name // empty' || true)"

          if [ -z "$latest" ] || [ "$latest" = "null" ]; then
            latest="v0.1.0"
          fi

          base="${latest#v}"
          IFS='.' read -r major minor patch <<< "$base"

          msg="${COMMIT_MSG}"
          bump="patch"

          if echo "$msg" | grep -qiE 'BREAKING CHANGE'; then
            bump="major"
          elif echo "$msg" | grep -qiE '^[[:space:]]*[^[:space:]]*!'; then
            bump="major"
          elif echo "$msg" | grep -qiE '^feat'; then
            bump="minor"
          fi

          case "$bump" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          next="v${major}.${minor}.${patch}"
          echo "version=$next" >> "$GITHUB_OUTPUT"
          echo "plain=${major}.${minor}.${patch}" >> "$GITHUB_OUTPUT"

      - name: Build Docker image
        run: docker build -f bot/Dockerfile -t rocinante-bot:ci ./bot

      - name: Create release
        id: release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.version }}" \
            --title "${{ steps.version.outputs.version }}" \
            --notes "Automated release for commit ${{ github.sha }}"
          echo "released=true" >> "$GITHUB_OUTPUT"

  publish:
    needs: build
    if: needs.build.outputs.released == 'true'
    uses: ./.github/workflows/bot-publish.yml
    with:
      version: ${{ needs.build.outputs.version }}
    permissions:
      contents: read
      packages: write