version: '3.8'

services:
  # Bot image builder - run `docker-compose build` to build both images
  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    image: rocinante-bot:latest
    profiles:
      - build-only  # Won't start with `docker-compose up`, only built
    command: ["echo", "Bot image built successfully"]

  management:
    build: ./web
    container_name: rocinante_management
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - CONFIG_PATH=/data/bots.json
      - BOT_IMAGE=rocinante-bot:latest
      - BOT_PATH=/bot
      - CLAUDE_API_KEY=${CLAUDE_API_KEY:-}
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Persistent config storage
      - ./data:/data
      # Bot source for auto-building image
      - ./bot:/bot:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
